# 英语单词量测试小程序 - 后端架构设计文档

## 1. 项目概述

### 1.1 项目背景
英语单词量测试小程序后端服务，为微信小程序提供API接口支持，实现用户管理、测试功能、数据统计等核心功能。

### 1.2 技术架构
- **开发语言**: Python 3.9+
- **Web框架**: Django 4.2
- **数据库**: MySQL 8.0
- **API框架**: Django REST Framework 3.14
- **后台管理**: Django Admin + SimpleUI
- **缓存**: Redis 6.0
- **部署**: Docker + Nginx

### 1.3 系统架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   微信小程序     │    │   后台管理      │    │   第三方服务    │
│   (前端)        │    │   (SimpleUI)    │    │   (微信API)     │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
                    ┌─────────────┴─────────────┐
                    │        Django 4.2         │
                    │    (Web Framework)        │
                    └─────────────┬─────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │      DRF 3.14            │
                    │   (API Framework)        │
                    └─────────────┬─────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │      MySQL 8.0            │
                    │      (Database)           │
                    └───────────────────────────┘
```

## 2. 项目目录结构

```
english_vocabulary_backend/
├── manage.py                          # Django管理脚本
├── requirements.txt                   # 项目依赖
├── docker-compose.yml                # Docker编排文件
├── Dockerfile                        # Docker镜像构建文件
├── .env.example                      # 环境变量示例
├── .gitignore                        # Git忽略文件
├── README.md                         # 项目说明文档
├── english_vocabulary/               # 项目主目录
│   ├── __init__.py
│   ├── settings/                     # 配置文件目录
│   │   ├── __init__.py
│   │   ├── base.py                  # 基础配置
│   │   ├── development.py           # 开发环境配置
│   │   ├── production.py            # 生产环境配置
│   │   └── test.py                  # 测试环境配置
│   ├── urls.py                      # 主URL配置
│   ├── wsgi.py                      # WSGI配置
│   └── asgi.py                      # ASGI配置
├── apps/                            # 应用目录
│   ├── __init__.py
│   ├── users/                       # 用户管理应用
│   │   ├── __init__.py
│   │   ├── admin.py                 # 后台管理配置
│   │   ├── apps.py                  # 应用配置
│   │   ├── models.py                # 用户模型
│   │   ├── serializers.py           # 序列化器
│   │   ├── views.py                 # 视图
│   │   ├── urls.py                  # URL配置
│   │   ├── permissions.py           # 权限控制
│   │   └── tests.py                 # 测试文件
│   ├── tests/                       # 测试管理应用
│   │   ├── __init__.py
│   │   ├── admin.py
│   │   ├── apps.py
│   │   ├── models.py                # 测试相关模型
│   │   ├── serializers.py
│   │   ├── views.py
│   │   ├── urls.py
│   │   ├── services.py              # 业务逻辑服务
│   │   └── tests.py
│   ├── vocabulary/                  # 词汇管理应用
│   │   ├── __init__.py
│   │   ├── admin.py
│   │   ├── apps.py
│   │   ├── models.py                # 词汇模型
│   │   ├── serializers.py
│   │   ├── views.py
│   │   ├── urls.py
│   │   └── tests.py
│   ├── ranking/                     # 排行榜应用
│   │   ├── __init__.py
│   │   ├── admin.py
│   │   ├── apps.py
│   │   ├── models.py                # 排行榜模型
│   │   ├── serializers.py
│   │   ├── views.py
│   │   ├── urls.py
│   │   └── tests.py
│   └── statistics/                  # 统计分析应用
│       ├── __init__.py
│       ├── admin.py
│       ├── apps.py
│       ├── models.py                # 统计模型
│       ├── serializers.py
│       ├── views.py
│       ├── urls.py
│       └── tests.py
├── core/                            # 核心功能模块
│   ├── __init__.py
│   ├── authentication.py            # 认证相关
│   ├── permissions.py               # 权限控制
│   ├── exceptions.py                # 异常处理
│   ├── utils.py                     # 工具函数
│   └── constants.py                 # 常量定义
├── api/                             # API版本管理
│   ├── __init__.py
│   ├── v1/                          # API v1版本
│   │   ├── __init__.py
│   │   ├── urls.py                  # API路由
│   │   └── views.py                 # API视图
│   └── docs/                        # API文档
├── static/                          # 静态文件
│   ├── admin/
│   ├── css/
│   ├── js/
│   └── images/
├── media/                           # 媒体文件
│   ├── avatars/                     # 用户头像
│   └── uploads/                     # 上传文件
├── templates/                       # 模板文件
│   ├── admin/
│   └── base.html
├── logs/                            # 日志文件
│   ├── django.log
│   ├── access.log
│   └── error.log
├── scripts/                         # 脚本文件
│   ├── deploy.sh                    # 部署脚本
│   ├── backup.sh                    # 备份脚本
│   └── init_data.py                 # 初始化数据脚本
└── docs/                            # 文档目录
    ├── api.md                       # API文档
    ├── deployment.md                # 部署文档
    └── development.md               # 开发文档
```

## 3. 数据库设计

### 3.1 数据库配置
```python
# settings/base.py
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'english_vocabulary',
        'USER': 'vocabulary_user',
        'PASSWORD': 'asdasd',
        'HOST': 'localhost',
        'PORT': '3306',
        'OPTIONS': {
            'charset': 'utf8mb4',
            'init_command': "SET sql_mode='STRICT_TRANS_TABLES'",
        },
    }
}
```

### 3.2 数据模型设计

#### 3.2.1 用户模型 (User)
```python
# apps/users/models.py
class User(AbstractUser):
    """用户模型"""
    openid = models.CharField(max_length=100, unique=True, verbose_name='微信OpenID')
    nickname = models.CharField(max_length=50, verbose_name='昵称')
    avatar = models.URLField(max_length=500, blank=True, verbose_name='头像')
    phone = models.CharField(max_length=20, blank=True, verbose_name='手机号')
    vocabulary_level = models.CharField(max_length=20, default='beginner', verbose_name='词汇水平')
    total_tests = models.IntegerField(default=0, verbose_name='总测试次数')
    average_score = models.DecimalField(max_digits=5, decimal_places=2, default=0, verbose_name='平均分数')
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='创建时间')
    updated_at = models.DateTimeField(auto_now=True, verbose_name='更新时间')

    class Meta:
        db_table = 'users'
        verbose_name = '用户'
        verbose_name_plural = '用户'
```

#### 3.2.2 词汇模型 (Vocabulary)
```python
# apps/vocabulary/models.py
class Vocabulary(models.Model):
    """词汇模型"""
    DIFFICULTY_CHOICES = [
        ('beginner', '初级'),
        ('intermediate', '中级'),
        ('advanced', '高级'),
        ('professional', '专业级'),
    ]
    
    word = models.CharField(max_length=100, unique=True, verbose_name='单词')
    phonetic = models.CharField(max_length=100, blank=True, verbose_name='音标')
    translation = models.TextField(verbose_name='中文释义')
    difficulty = models.CharField(max_length=20, choices=DIFFICULTY_CHOICES, verbose_name='难度等级')
    part_of_speech = models.CharField(max_length=50, blank=True, verbose_name='词性')
    example_sentence = models.TextField(blank=True, verbose_name='例句')
    frequency = models.IntegerField(default=0, verbose_name='使用频率')
    is_active = models.BooleanField(default=True, verbose_name='是否启用')
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='创建时间')

    class Meta:
        db_table = 'vocabulary'
        verbose_name = '词汇'
        verbose_name_plural = '词汇'
```

#### 3.2.3 测试记录模型 (TestRecord)
```python
# apps/tests/models.py
class TestRecord(models.Model):
    """测试记录模型"""
    TEST_TYPE_CHOICES = [
        ('vocabulary', '词汇量测试'),
        ('speed', '速度测试'),
        ('accuracy', '准确度测试'),
    ]
    
    user = models.ForeignKey(User, on_delete=models.CASCADE, verbose_name='用户')
    test_type = models.CharField(max_length=20, choices=TEST_TYPE_CHOICES, verbose_name='测试类型')
    difficulty = models.CharField(max_length=20, verbose_name='难度等级')
    total_questions = models.IntegerField(verbose_name='总题目数')
    correct_answers = models.IntegerField(verbose_name='正确答案数')
    score = models.DecimalField(max_digits=5, decimal_places=2, verbose_name='得分')
    vocabulary_level = models.CharField(max_length=20, verbose_name='词汇水平')
    duration = models.IntegerField(verbose_name='测试时长(秒)')
    start_time = models.DateTimeField(verbose_name='开始时间')
    end_time = models.DateTimeField(verbose_name='结束时间')
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='创建时间')

    class Meta:
        db_table = 'test_records'
        verbose_name = '测试记录'
        verbose_name_plural = '测试记录'
```

#### 3.2.4 题目模型 (Question)
```python
# apps/tests/models.py
class Question(models.Model):
    """题目模型"""
    QUESTION_TYPE_CHOICES = [
        ('choice', '选择题'),
        ('fill_blank', '填空题'),
        ('matching', '匹配题'),
    ]
    
    vocabulary = models.ForeignKey(Vocabulary, on_delete=models.CASCADE, verbose_name='相关词汇')
    question_type = models.CharField(max_length=20, choices=QUESTION_TYPE_CHOICES, verbose_name='题目类型')
    question_text = models.TextField(verbose_name='题目内容')
    options = models.JSONField(verbose_name='选项')
    correct_answer = models.CharField(max_length=200, verbose_name='正确答案')
    explanation = models.TextField(blank=True, verbose_name='解释')
    difficulty = models.CharField(max_length=20, verbose_name='难度等级')
    is_active = models.BooleanField(default=True, verbose_name='是否启用')
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='创建时间')

    class Meta:
        db_table = 'questions'
        verbose_name = '题目'
        verbose_name_plural = '题目'
```

#### 3.2.5 排行榜模型 (Ranking)
```python
# apps/ranking/models.py
class Ranking(models.Model):
    """排行榜模型"""
    RANKING_TYPE_CHOICES = [
        ('daily', '日榜'),
        ('weekly', '周榜'),
        ('monthly', '月榜'),
        ('all_time', '总榜'),
    ]
    
    user = models.ForeignKey(User, on_delete=models.CASCADE, verbose_name='用户')
    ranking_type = models.CharField(max_length=20, choices=RANKING_TYPE_CHOICES, verbose_name='排行榜类型')
    score = models.DecimalField(max_digits=5, decimal_places=2, verbose_name='分数')
    vocabulary_level = models.CharField(max_length=20, verbose_name='词汇水平')
    rank_position = models.IntegerField(verbose_name='排名位置')
    test_count = models.IntegerField(default=1, verbose_name='测试次数')
    period_start = models.DateField(verbose_name='统计开始日期')
    period_end = models.DateField(verbose_name='统计结束日期')
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='创建时间')

    class Meta:
        db_table = 'rankings'
        verbose_name = '排行榜'
        verbose_name_plural = '排行榜'
        unique_together = ['user', 'ranking_type', 'period_start']
```

## 4. API接口设计

### 4.1 API版本管理
```
/api/v1/ - 当前版本
/api/v2/ - 未来版本
```

### 4.2 认证接口
```python
# 用户登录
POST /api/v1/auth/login/
{
    "code": "微信授权码",
    "user_info": {
        "nickName": "用户昵称",
        "avatarUrl": "头像URL"
    }
}

# 获取用户信息
GET /api/v1/auth/profile/
Authorization: Bearer <token>

# 更新用户信息
PUT /api/v1/auth/profile/
Authorization: Bearer <token>
{
    "nickname": "新昵称",
    "phone": "手机号"
}
```

### 4.3 测试接口
```python
# 获取测试题目
GET /api/v1/tests/questions/
Authorization: Bearer <token>
{
    "test_type": "vocabulary",
    "difficulty": "intermediate",
    "question_count": 20
}

# 提交测试答案
POST /api/v1/tests/submit/
Authorization: Bearer <token>
{
    "test_id": "uuid",
    "answers": [
        {"question_id": 1, "answer": "A"},
        {"question_id": 2, "answer": "B"}
    ],
    "duration": 900
}

# 获取测试结果
GET /api/v1/tests/result/{test_id}/
Authorization: Bearer <token>
```

### 4.4 历史记录接口
```python
# 获取测试历史
GET /api/v1/history/
Authorization: Bearer <token>
{
    "page": 1,
    "page_size": 20,
    "test_type": "vocabulary",
    "date_from": "2024-01-01",
    "date_to": "2024-01-31"
}

# 获取学习统计
GET /api/v1/history/statistics/
Authorization: Bearer <token>
```

### 4.5 排行榜接口
```python
# 获取排行榜
GET /api/v1/ranking/
Authorization: Bearer <token>
{
    "ranking_type": "weekly",
    "page": 1,
    "page_size": 50
}

# 获取用户排名
GET /api/v1/ranking/user-rank/
Authorization: Bearer <token>
{
    "ranking_type": "weekly"
}
```

### 4.6 词汇库接口
```python
# 获取词汇列表
GET /api/v1/vocabulary/
Authorization: Bearer <token>
{
    "difficulty": "intermediate",
    "search": "apple",
    "page": 1,
    "page_size": 20
}

# 获取词汇详情
GET /api/v1/vocabulary/{word}/
Authorization: Bearer <token>
```

## 5. 后台管理设计

### 5.1 SimpleUI配置
```python
# settings/base.py
INSTALLED_APPS = [
    'simpleui',  # 必须在django.contrib.admin之前
    'django.contrib.admin',
    # ... 其他应用
]

# SimpleUI配置
SIMPLEUI_CONFIG = {
    'system_keep': False,
    'menu_display': ['用户管理', '测试管理', '词汇管理', '排行榜管理'],
    'dynamic': True,
    'menus': [
        {
            'name': '用户管理',
            'icon': 'fas fa-users',
            'models': [
                {
                    'name': '用户列表',
                    'url': 'users/user/',
                    'icon': 'fas fa-user'
                }
            ]
        },
        {
            'name': '测试管理',
            'icon': 'fas fa-clipboard-list',
            'models': [
                {
                    'name': '测试记录',
                    'url': 'tests/testrecord/',
                    'icon': 'fas fa-list'
                },
                {
                    'name': '题目管理',
                    'url': 'tests/question/',
                    'icon': 'fas fa-question-circle'
                }
            ]
        }
    ]
}
```

### 5.2 自定义Admin
```python
# apps/users/admin.py
from django.contrib import admin
from .models import User

@admin.register(User)
class UserAdmin(admin.ModelAdmin):
    list_display = ['id', 'nickname', 'openid', 'vocabulary_level', 'total_tests', 'average_score', 'created_at']
    list_filter = ['vocabulary_level', 'created_at']
    search_fields = ['nickname', 'openid']
    readonly_fields = ['openid', 'created_at', 'updated_at']
    
    fieldsets = (
        ('基本信息', {
            'fields': ('nickname', 'avatar', 'phone')
        }),
        ('学习信息', {
            'fields': ('vocabulary_level', 'total_tests', 'average_score')
        }),
        ('系统信息', {
            'fields': ('openid', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )
```

## 6. 缓存策略

### 6.1 Redis配置
```python
# settings/base.py
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': 'redis://:123456@127.0.0.1:6379/1',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    }
}
```

### 6.2 缓存策略
- **用户信息缓存**: 30分钟
- **词汇数据缓存**: 1小时
- **排行榜缓存**: 10分钟
- **测试题目缓存**: 1小时

## 7. 安全配置

### 7.1 认证配置
```python
# settings/base.py
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ],
    'DEFAULT_THROTTLE_CLASSES': [
        'rest_framework.throttling.AnonRateThrottle',
        'rest_framework.throttling.UserRateThrottle'
    ],
    'DEFAULT_THROTTLE_RATES': {
        'anon': '100/hour',
        'user': '1000/hour'
    }
}
```

### 7.2 CORS配置
```python
# settings/base.py
CORS_ALLOWED_ORIGINS = [
    "https://your-domain.com",
]

CORS_ALLOW_CREDENTIALS = True
```

## 8. 部署配置

### 8.1 Docker配置
```dockerfile
# Dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

EXPOSE 8000

CMD ["gunicorn", "--bind", "0.0.0.0:8000", "english_vocabulary.wsgi:application"]
```

### 8.2 Docker Compose
```yaml
# docker-compose.yml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DJANGO_SETTINGS_MODULE=english_vocabulary.settings.production
    depends_on:
      - db
      - redis
    volumes:
      - ./media:/app/media
      - ./logs:/app/logs

  db:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: english_vocabulary
      MYSQL_USER: vocabulary_user
      MYSQL_PASSWORD: secure_password
      MYSQL_ROOT_PASSWORD: root_password
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"

  redis:
    image: redis:6.0
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  mysql_data:
  redis_data:
```

## 9. 性能优化

### 9.1 数据库优化
- 使用数据库索引优化查询性能
- 实现数据库读写分离
- 使用数据库连接池

### 9.2 缓存优化
- 实现多级缓存策略
- 使用Redis缓存热点数据
- 实现缓存预热机制

### 9.3 代码优化
- 使用异步处理提高并发性能
- 实现API接口限流
- 优化数据库查询，减少N+1问题

## 10. 监控与日志

### 10.1 日志配置
```python
# settings/base.py
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': 'logs/django.log',
            'formatter': 'verbose',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file'],
            'level': 'INFO',
            'propagate': True,
        },
    },
}
```

### 10.2 监控指标
- API响应时间
- 数据库查询性能
- 缓存命中率
- 错误率统计
- 用户活跃度

## 11. 测试策略

### 11.1 单元测试
```python
# apps/tests/tests.py
from django.test import TestCase
from django.contrib.auth import get_user_model
from .models import TestRecord

class TestRecordTestCase(TestCase):
    def setUp(self):
        self.user = get_user_model().objects.create_user(
            username='testuser',
            password='testpass123'
        )
    
    def test_create_test_record(self):
        test_record = TestRecord.objects.create(
            user=self.user,
            test_type='vocabulary',
            difficulty='intermediate',
            total_questions=20,
            correct_answers=15,
            score=75.0,
            vocabulary_level='intermediate',
            duration=900
        )
        self.assertEqual(test_record.score, 75.0)
```

### 11.2 集成测试
- API接口测试
- 数据库操作测试
- 缓存功能测试

### 11.3 性能测试
- 负载测试
- 压力测试
- 并发测试

## 12. 开发规范

### 12.1 代码规范
- 遵循PEP 8编码规范
- 使用类型注解
- 编写详细的文档字符串
- 使用Black进行代码格式化

### 12.2 Git工作流
- 使用Git Flow工作流
- 提交信息遵循Conventional Commits规范
- 代码审查流程

### 12.3 环境管理
- 使用虚拟环境
- 环境变量管理
- 配置文件分离

## 13. 项目依赖

### 13.1 requirements.txt
```
Django==4.2.7
djangorestframework==3.14.0
djangorestframework-simplejwt==5.3.0
django-cors-headers==4.3.1
django-simpleui==2023.12.12
django-redis==5.4.0
mysqlclient==2.2.0
gunicorn==21.2.0
celery==5.3.4
redis==5.0.1
Pillow==10.1.0
python-decouple==3.8
django-filter==23.5
drf-yasg==1.21.7
```

## 14. 总结

本架构设计文档详细描述了英语单词量测试小程序后端的技术架构、数据库设计、API接口、部署配置等各个方面。通过采用Django 4 + DRF + MySQL的技术栈，结合SimpleUI美化后台管理，能够为微信小程序提供稳定、高效的后端服务支持。

该架构具有良好的可扩展性、可维护性和性能表现，能够满足项目的功能需求和非功能需求。 